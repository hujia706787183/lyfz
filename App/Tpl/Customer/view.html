<include file="Public:header_uncompatible" />
<include file="Public:nav" />
<script src="__PUBLIC__/js/WdatePicker.js?t=20140830" type="text/javascript"></script>
<link href="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
<link href="https://cdn.bootcss.com/element-ui/1.4.6/theme-default/index.css" rel="stylesheet">
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>

<style>

    .el-date-editor.el-input {
        width: 100%;
    }

    /*定义滚动条高宽及背景 高宽分别对应横竖滚动条的尺寸*/  
    ::-webkit-scrollbar  
    {  
        width: 9px;
        height: 9px;
        background-color: #F5F5F5;  
    }  
    
    /*定义滚动条轨道 内阴影+圆角*/  
    ::-webkit-scrollbar-track  
    {  
        -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);  
        background-color: #F5F5F5;  
    }  
    
    /*定义滑块 内阴影+圆角*/  
    ::-webkit-scrollbar-thumb  
    {  
        -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);  
        background-color: #C0CCDA;  
    }
    
    .title {
        font-size: 14px;
    }

    .screenshot{
        width:60px;
        height:60px;
        background-color:red;
        float:left;
        border:1px solid #ccc;
        border-radius:5px;
        /*margin:10px 10px;*/
    }

</style>
<div class="container no-mar-top no-bg" >
<div class="row" >
    <div class="col-md-2" >
        <div class="list-group">
            <div class="list-group-item">
                <span class="title">
                    {$customer['name']}
                </span>
            </div>
            <a class="list-group-item" href="#tab1">基本信息</a>
            <a class="list-group-item" href="#tab3">{:L('COMMUNICATION_LOGS')}
                <span class="badge pull-right"><if condition="$customer['log_count']">{$customer['log_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab10">{:L('BUSINESS_HISTORY')}
                <span class="badge pull-right"><if condition="$customer['business_count']">{$customer['business_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab12">{:L('CUMTOMER_CARE')}
                <span class="badge pull-right"><if condition="$customer['cares_count']">{$customer['cares_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab7">{:L('PRODUCT_INFO')}
                <span class="badge pull-right"><if condition="$customer['product_count']">{$customer['product_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab11">{:L('CONTRACT')}
                <span class="badge pull-right"><if condition="$customer['contract_count']">{$customer['contract_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab8">{:L('ORDER')} / {:L('RECEIVE_MONEY')}
                <span class="badge pull-right"><if condition="$customer['receivables_count']">{$customer['receivables_count']}</if></span>
            </a>
<!--             <a class="list-group-item" href="#tab9">{:L('The_accounts_payable')}
                <span class="badge pull-right"><if condition="$customer['payables_count']">{$customer['payables_count']}</if></span>
            </a> -->
            <a class="list-group-item" href="#tab5">{:L('TASK')}
                <span class="badge pull-right"><if condition="$customer['task_count']">{$customer['task_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab6">{:L('SCHEDULE')}
                <span class="badge pull-right"><if condition="$customer['event_count']">{$customer['event_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab4">{:L('FILE')}
                <span class="badge pull-right"><if condition="$customer['file_count']">{$customer['file_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab15">{:L('DOOR_SERVICE')}
                <span class="badge pull-right"><if condition="$customer['door_service_count']">{$customer['door_service_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab14">{:L('REMOTE_SERVICE')}
                <span class="badge pull-right"><if condition="$customer['remote_service_count']">{$customer['remote_service_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab18">网络培训服务
                <span class="badge pull-right"><if condition="$customer['remote_service_count']">{$customer['net_train_service_count']}</if></span>
            </a>
            <a class="list-group-item" href="#tab16">{:L('DELIVERY_MODULE')}
                <span class="badge pull-right"><if condition="$express">{:count($express)}</if></span>
            </a>
            <a class="list-group-item" href="#tab17">通话记录
                <span class="badge pull-right"></span>
            </a>
        </div>
    </div>
    <div class="col-md-10 tab-content">
        <include file="Public:alert"/>
        <div class="tab-pane fade in active" id="tab1">
            <div class="col-md-9">
                <div class="container2 top-pad">
                    <h4 class="page-header">
                        {:L('BASIC_INFORMATION')}
                        <div class="pull-right" style="margin-top: -6px">
                            <if condition="($Think.get.content neq 'resource') and ($customer['is_deleted'] eq 0)">
                                <php>
                                    $focus_id = M('CustomerFocus')
                                    ->where('user_id =%d and customer_id=%d',session('role_id'),$customer['customer_id'])
                                    ->getField('focus_id');
                                </php>
                                <if condition="$focus_id">
                                    <a href="{:U('customer/batchclose', 'customer_id='.$customer['customer_id'])}" class="btn btn-primary btn-sm">取消关注</a>
                                <else/>
                                    <a href="{:U('customer/batchfocus', 'customer_id='.$customer['customer_id'])}" class="btn btn-primary btn-sm">关注</a>
                                </if>
                                <php>
                                    $share_id = M('CustomerShare')->where('share_role_id =%d and customer_id=%d',session('role_id'),$customer['customer_id'])->getField('share_id');
                                    $by_sharing_ids = M('CustomerShare')->where('customer_id=%d',$customer['customer_id'])->getField('by_sharing_id',true);
                                    if(!in_array(session('role_id'),explode(',',implode(',',$by_sharing_ids)))||$share_id)
                                    {
                                </php>
                                    <if condition="$share_id">
                                        <a href="{:U('customer/close_share', 'customer_id='.$customer['customer_id'])}" class="btn btn-primary btn-sm">取消分享</a>
                                    <else/>
                                        <a id="share" href="javascript:void(0)" class="btn btn-primary btn-sm">分享</a>
                                    </if>
                                <php> 
                                    } 
                                </php>
                            </if>
                            <?php
                                if(!in_array(session('role_id'),explode(',',implode(',',$by_sharing_ids)))||$share_id){
                            ?>
                                <a href="{:U('customer/edit', 'id='.$customer['customer_id'])}" class="btn btn-primary btn-sm">{:L('EDIT')}</a>
                                <a href="{:U('customer/delete','id='.$customer['customer_id'])}" class="btn btn-primary btn-sm del_confirm">{:L('DELETE')}</a>
                            <?php } ?>
                            <a href="javascript:void(0)" class="btn btn-primary btn btn-primary btn-sm" onclick="javascript:history.go(-1)">{:L('RETURN')}</a>
                        </div>
                    </h4>
                </div>
                <div class="back_box" style="margin-top:10px;">

                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <td class="tdleft" width="15%">{:L('THE_PRIMARY_CONTACT')}</td>
                                <td><a href="{:U('contacts/view','id='.$customer[contacts_id])}">{$customer[contacts_name]}</td>
                            <php>$j=0;</php>
                            <volist name="field_list" id="vo">
                            <php>$j++;</php>
                            <if condition="$vo['form_type'] == 'textarea' or $vo['form_type'] == 'editor'">
                                <if condition="$i%2 != 0">
                                <td colspan="2">&nbsp;</td>
                                </tr>
                                </if>
                                <tr>
                                    <td class="tdleft" width="15%">{$vo.name}:</td>
                                    <td colspan="3" style="word-break:break-word;">{$customer[$vo['field']]}</td>
                                </tr>
                                <if condition="$i%2 == 0 && count($field_list) != $j">
                                <php>$i++;</php>
                                </if>
                            <else/>
                                <if condition="$i%2 == 0">
                                <tr>
                                </if>
                                    <td class="tdleft" width="15%">{$vo.name}:</td>
                                    <td width="35%">
                                        <span> <!--style="color:#{$vo['color']}" -->
                                        <if condition="$vo['form_type'] eq 'datetime'">
                                            <if condition="$customer[$vo['field']] gt 0">{$customer[$vo['field']]|date='Y-m-d',###}</if>
                                        <elseif condition="$vo['form_type'] eq 'address'" />
                                            {$customer[$vo['field']]}
                                            <a href="javascript:void(0);" class="getMap" rel="{$customer[$vo['field']]}">
                                                <img src="__PUBLIC__/img/location.png" style="height:20px; vertical-align: text-bottom;">
                                            </a>
                                        <else />
                                            {$customer[$vo['field']]}
                                        </if>
                                        </span>
                                    </td>
                                <if condition="$i%2 != 0">
                                </tr>
                                </if>
                                <if condition="$i%2 == 0 && count($field_list) == $j">
                                    <td colspan="2">&nbsp;</td>
                                </tr>
                                </if>
                            </if>
                            </volist>
                            <tr>
                                <td class="tdleft" width="15%">{:L('CREATION_TIME')}</td>
                                <td><if condition="$customer['create_time'] neq 0">{$customer.create_time|date='Y-m-d H:i:s',###}</if></td>
                                <td class="tdleft" width="15%">{:L('THE_LAST_MODIFICATION_TIME')}</td>
                                <td><if condition="$customer['update_time'] gt 0">{$customer.update_time|date='Y-m-d H:i:s',###}</if></td>
                            </tr>
                            <if condition="$customer['is_deleted'] eq 1">
                                <tr>
                                    <td class="tdleft">{:L('DELETE_THE_PEOPLE')}</td>
                                    <td><a class="role_info" href="javascript:void(0)" rel="{$customer.deleted.role_id}">{$customer.deleted.user_name}</a></td>
                                    <td class="tdleft" width="15%">{:L('DELETE_THE_TIME')}</td>
                                    <td>{$customer.delete_time|date='Y-m-d H:i:s',###}</td>
                                </tr>
                            </if>
                            <tr>
                            <td class="tdleft">{:L('PRINCIPAL')}</td>
                                <td><a class="role_info" href="javascript:void(0)" rel="{$customer.owner.role_id}">{$customer.owner.user_name}</if></a> &nbsp;  &nbsp; <a href="{:U('customer/customerlock','customer_id='.$customer['customer_id'])}"><if condition="$customer['is_locked'] and $customer['owner_role_id']"><img title="{:L('UNLOCK_TITLE')}" src="__PUBLIC__/img/customer_locking.png"/><elseif condition="$customer['owner_role_id']"/><img title="{:L('LOCK_TITLE')}" src="__PUBLIC__/img/customer_unlocking.png"/></if></a></td>
                                <td class="tdleft">{:L('FOUNDER')}</td>
                                <td><a class="role_info" href="javascript:void(0)" rel="{$customer.create.role_id}">{$customer.create.user_name}</if></a></td>
                            </tr>
                            <volist name="door_service_person_list" id="name">
                                <tr>
                                   <td>
                                       第{$i}次上门
                                   </td>
                                   <td colspan="3">
                                       {$name}
                                   </td>
                                </tr>
                            </volist>
                            <volist name="customer_extra_info" id="info">
                                <tr>
                                   <td>
                                       {:L($info['extra_key'])}{$i}
                                   </td>
                                   <td colspan="3">
                                       {$info.extra_value}
                                   </td>
                                </tr>
                            </volist>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 10px;">
                    <div class="header1">
                        <div class="pull-left two-title" >{:L('LINKMAN')}</div>
                        <div class="pull-right"> <if condition="$customer['is_deleted'] == 0"><a href="{:U('contacts/add','redirect=customer&customer_id='.$customer['customer_id'])}" class=" btn btn-primary">{:L('ADD')}</a></if></div>
                        <div style="clear:both;"></div>
                    </div>
                    <table class="table table-hover">
                        <if condition="$customer.contacts eq null">
                            <tr>
                                <td <if condition="C('ismobile') neq 1">colspan="6"<else/>colspan="4"</if>>{:L('THERE_IS_NO_DATA')} </td>
                            </tr>
                        <else /> 
                            <tr>
                                <td width="18%">&nbsp;</td>
                                <td width="20%">{:L('NAME')}</td>
                                <td width="10%">职位</td>
                                <td width="10%">{:L('CELLPHONE')}</td>
                                <td width="10%">QQ</td>
                                <td width="16%">email</td>
                            </tr>
                            <volist name="customer['contacts']" id="vo">
                                <tr>
                                    <td class="tdleft" >
                                        <if condition="$customer['is_deleted'] == 0"><a href="{:U('contacts/view', 'id='.$vo['contacts_id'])}">{:L('CHECK')}</a> &nbsp;<a href="{:U('contacts/edit', 'id='.$vo['contacts_id'].'&redirect=customer&redirect_id='.$customer['customer_id'])}">{:L('COMPILE')}</a>&nbsp;
                                        <a href="{:U('contacts/mdelete', 'id='.$vo['contacts_id'].'&r=rContactsCustomer&module_id='.$customer['customer_id'])}" class="del_confirm">{:L('DELETE')}</a>&nbsp;
                                        <a href="{:U('contacts/changeToFirstContact', 'id='.$vo['contacts_id'].'&customer_id='.$customer['customer_id'])}">{:L('SET_AS_PRIMARY')}</a>
                                        </if>
                                    </td>
                                    <td>
                                        {$vo.name}<if condition="$vo['is_firstContact'] eq 'true'"> &nbsp;<span style="color:red;">( {:L('THE_PRIMARY_CONTACT')} )</span></if>{$vo.saltname}
                                    </td>
                                    <td>
                                        <if condition="C('ismobile') eq 1"><a href="tel:{$vo.post}">{$vo.telephone}</a><else />{$vo.post}</if>
                                    </td>
                                    <td>
                                        <if condition="C('ismobile') eq 1"><a href="tel:{$vo.telephone}">{$vo.telephone}</a><else />{$vo.telephone}</if>
                                    </td>
                                     <td>
                                        <if condition="C('ismobile') eq 1"><a href="qq:{$vo.qq_no}">{$vo.qq_no}</a><else />{$vo.qq_no}</if>
                                    </td>
                                    <td>
                                        <if condition="C('ismobile') eq 1"><a href="mailto:{$vo.email}">{$vo.email}</a><else />{$vo.email}</if>
                                    </td>
                                </tr>
                            </volist>
                        </if>
                    </table>
                </div> 
            </div>

            <div class="col-md-3">
                <ul class="nav nav-list bs-docs-sidenav  span2 widths" >
                    <li class="active first-li"><span class="spans1">编辑详情</span></li>
                    <if condition="$customer['owner_role_id'] == 0">
                        <li><a rel="{$customer['customer_id']}" class="fenpei" href="javascript:void(0)"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('DISTRIBUTION')}</a></li>  
                        <li><a href="{:U('customer/receive', 'customer_id='.$customer['customer_id'])}"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('RECEIVE')}</a> </li>
                        <else/>
                        <li><a href="{:U('customer/fenpei', 'by=put&customer_id='.$customer['customer_id'])}"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('IN_THE_CUSTOMER_POOL')}</a></li> 
                    </if>
                    <li><a href="{:U('contacts/add','redirect=customer&customer_id='.$customer['customer_id'])}"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('ADD_A_CONTACT')}</a> </li>
                    <li><a href="javascript:void(0);" class="add_log"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('ADD_THE_COMMUNICATION_LOG')}</a></li> 
                    <li><a href="javascript:void(0);" class="add_task"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('ADD_TASKS')}</a></li> 
                    <li><a href="javascript:void(0);" class="add_event"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('ADD_THE_SCHEDULE')}</a></li>
                    <li><a href="javascript:void(0);" class="add_file"><img src="__PUBLIC__/img/youce.png"/>&nbsp;&nbsp;&nbsp;{:L('ADD_FILES')}</a></li>
                </ul>
            </div> 
        </div>
        <div class="tab-pane fade back_box" id="tab3">
            <h4 class="page-header clearfix">
                <span>{:L('COMMUNICATION_LOGS')}</span>
                <if condition="$customer['is_deleted'] == 0">
                    <div class="pull-right">
                        <a class="add_log btn btn-primary btn-sm" href="javascript:void(0);" >{:L('ADD')}</a>
                    </div>
                <else/>
                    <span class="pull-right">{:L('HAS BEEN REMOVED')}</span>
                </if>
            </h4>
            <table class="table table-hover">
                <if condition="$customer.log eq null">
                    <div>
                        {:L('THERE_IS_NO_DATA')}
                    </div>
                <else />
                    <volist name="customer.log" id="vo">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                {$vo.subject}
                            </div>
                            
                        <div class="panel-body">
                                <if condition="strlen($vo['content']) gt 100">
                                    <div id="slog_{$vo.log_id}" class="pad-right3" >
                                        {$vo.content|msubstr=###,0,100}
                                            <a class="more" rel="{$vo.log_id}" href="javascript:void(0)">{:L('READ_MORE')}</a>
                                    </div>
                                    <div id="llog_{$vo.log_id}"  class="hide">
                                        <div class="pad-right3 pres" >{$vo.content}</div>
                                    </div>
                                <else/>
                                 <div class="pad-right3"> {$vo.content}</div>
                                </if>
                            </div>
                            <div class=" clearfix">
                                <div class="editors pull-right">
                                    <if condition="$customer['is_deleted'] neq 1"><a href="javascript:void(0)" rel="{$vo.log_id}" class="edit_log">{:L('COMPILE')}</a>&nbsp; <a href="{:U('log/delete','r=RCustomerLog&id='.$vo['log_id'])}" class="del_confirm">{:L('DELETE')}</a></if>
                                    <notempty name="vo.owner.user_name"><img style="margin-top:-3px;" src="__PUBLIC__/img/user.png">&nbsp;<a class="role_info name-colors"  rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a></notempty> &nbsp; 
                                    <img src="__PUBLIC__/img/time_annoce.png"/>&nbsp;<span class=" name-colors" >{$vo.update_date|date="Y-m-d  H:i:s",###}</span> &nbsp; 
                                    <notempty name="vo.create_date"> &nbsp; </notempty>
                                    <if condition="C('ismobile') eq 1"><br/></if>
                                </div>
                            </div>

                        </div>

                    </volist>
                </if>
            </table>
        </div>
        <!-- 商机历史 -->
        <div class="tab-pane fade back_box" id="tab10">
            <h4 class="page-header clearfix">
                <span>{:L('BUSINESS_HISTORY')}</span>
                <if condition="$customer['is_deleted'] == 0">
                    <div class="pull-right">
                        <a class="btn btn-primary btn-sm" href="{:U('business/add','customer_id='.$customer['customer_id'])}" >{:L('add')}</a>
                    </div>
                <else/>
                    <span class="pull-right">{:L('HAS BEEN REMOVED')}</span>
                </if>
            </h4>
            <table class="table table-hover">
                <if condition="$customer.business eq null">
                    <tr>
                        <td <if condition="C('ismobile') neq 1">colspan="5"<else/>colspan="4"</if>>{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                    <tr>
                        <td width="15%">&nbsp;</td>
                        <td>{:L('BUSINESS_NAME')}</td>
                        <td>{:L('STATE')}</td>
                        <td>{:L('PRINCIPAL')}</td>
                        <if condition="C('ismobile') neq 1"><td>{:L('creation_time')}</td></if>
                    </tr>
                    <volist name="customer.business" id="vo">
                        <tr>
                            <td class="tdleft" >
                                <if condition="$customer['is_deleted'] == 0"><a href="{:U('business/view', 'id='.$vo['business_id'])}">{:L('CHECK')}</a> &nbsp;<a href="{:U('business/edit', 'id='.$vo['business_id'])}">{:L('COMPILE')}</a></if>
                            </td>
                            <td>
                                <a href="{:U('business/view', 'id='.$vo['business_id'])}">{$vo.name}</a>
                            </td>
                            <td>
                                {$vo.status}
                            </td>                                       
                            <td>
                                <notempty name="vo.owner.user_name">
                                <a class="role_info" rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a>
                                </notempty>
                            </td>
                            <if condition="C('ismobile') neq 1">
                                <td>
                                    <if condition="$vo['create_time'] gt 0">{$vo.create_time|date="Y-m-d",###}</if>
                                </td>
                            </if>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 客户关怀 -->
        <div class="tab-pane fade back_box" id="tab12">
            <h4 class="page-header clearfix">
                <span>{:L('CUMTOMER_CARE')}</span>
                <if condition="$customer['is_deleted'] == 0">
                    <div class="pull-right">
                        <a class="btn btn-success btn-sm" href="{:U('customer/caresadd','customer_id='.$customer['customer_id'])}" >{:L('ADD')}</a>
                    </div>
                <else/>
                    <span class="pull-right">{:L('HAS BEEN REMOVED')}</span>
                </if>
            </h4>
            <table class="table table-hover">
                <empty name="customer['cares']">
                    <tr>
                        <td colspan="5">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                    <tr>
                        <td width="15%">&nbsp;</td>
                        <td>{:L('CARE_THEME')}</td>
                        <td>{:L('DATE_OF_CARE')}</td>
                        <td>{:L('TYPE')}</td>
                        <td>{:L('PRINCIPAL')}</td>
                    </tr>
                    <volist name="customer.cares" id="vo">
                        <tr>
                            <td class="tdleft">
                                <a href="{:U('customer/caresview','id='.$vo['care_id'])}">{:L('CHECK')}</a>&nbsp; <a href="{:U('customer/caresdelete','id='.$vo['care_id'])}" class="del_confirm">{:L('DELETE')}</a>
                            </td>
                            <td>
                                {$vo.subject}
                            </td>
                            <td>
                                <present name="vo.care_time">{$vo.care_time|date="Y-m-d H:i:s",###}</present>
                            </td>
                            <td>
                                <if condition="$vo['type'] == 'message'">
                                    {:L('NOTE')}
                                <elseif condition="$vo['type'] == 'phone'"/>
                                    {:L('PHONE')}
                                <elseif condition="$vo['type'] == 'email'"/>
                                    {:L('EMAIL')}
                                <elseif condition="$vo['type'] == 'other'"/>
                                    {:L('OTHER')}
                                <else/>
                                    {:L('NONE')}
                                </if>
                            </td>
                            <td>
                                <notempty name="vo.to_name">{$vo.to_name}</notempty>
                            </td>
                        </tr>
                    </volist>
                </empty>
            </table>
        </div>
        <!-- 购买产品 -->
        <div class="tab-pane fade back_box" id="tab7">
            <h4 class="page-header">
                <span>{:L('PRODUCT_INFO')}</span>
            </h4>
            <table class="table table-hover">
                <if condition="$customer.product eq null">
                    <tr>
                        <td colspan="8">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                    <thead>
                        <tr>
                            <td width="15%">序号</td>
                            <td>{:L('PRODUCT_NAME')}</td>
                            <td>原价</td>
                            <td>{:L('QUANTITY')}</td>
                            <td>小计</td>
                            <td>订单价格</td>
                            <if condition="C('ismobile') neq 1"><td width="30%">{:L('REMARK')}</td></if>
                            <td>操作</td>
                        </tr>
                    </thead>
                    <tbody>
                        <volist name="customer.product" id="product" key="index">
                            <tr>
                                <!-- <td class="tdleft"><a href="{:U('product/view', 'id='.$product['product_id'])}">{:L('CHECK')}</a></td> -->
                                <td class="tdleft">{$index}</td>
                                <td>
                                    <a href="{:U('product/view', 'id='.$product['product_id'])}">{$product.name}</a>
                                </td>
                                <td>{$product.unit_price}</td>
                                <td>
                                    {$product.amount}
                                </td>
                                <td>
                                    {$product.subtotal}
                                </td>
                                <td>{$product.order_price}</td>
                                <td>
                                    {$product.description}
                                </td>
                                <td>
                                    <button type="button" data-order-product-id="{$product.order_product_id}" data-product-id="{$product.product_id}" class="btn btn-primary btn-sm open_set_product_info_dialog">
                                        设置产品信息
                                    </button>
                                </td>
                            </tr>
                            <volist name="product.extra_info"  id="value">
                                <tr>
                                    <td>{:L($key)}:</td>
                                    <td colspan="8">
                                        <if condition="$key eq 'next_service_fee_date'">
                                            {:date('Y-m-d H:i:s',$value)}
                                        <else/>
                                            {$value}
                                        </if>

                                    </td>
                                </tr>
                            </volist>
                                <tr>
                                    <td colspan="8" id="productButton-{$product.order_product_id}">
                                        <script>
                                            (function(){
                                                var product_id = "{$product.product_id}";
                                                var order_product_id = "{$product.order_product_id}";
                                                $.get({
                                                    url: '{:U("Customer/productButton")}',
                                                    data: {product_id: product_id, order_product_id: order_product_id},
                                                }).then(function (product) {
                                                    $('#productButton-'+order_product_id).html(product);
                                                });
                                            })();
                                        </script>
                                    </td>
                                </tr>
                        </volist>
                    </tbody>
                </if>
            </table>
            <!-- Modal -->

            <include file="Product:product_modal"/>
            <script>
                $('.open_set_product_info_dialog').on('click', function(){
                    var product_id = $(this).data('product-id');
                    var order_product_id = $(this).data('order-product-id');
                    $.ajax({
                        url: '{:U("Customer/product")}',
                        type: 'get',
                        data: {product_id: product_id, order_product_id: order_product_id},
                        success: function (product) {
                            $('#product_info_form').html(product);
                        },
                        error: function () {
                            console.log('错误');
                        }
                    });
                    $('#myModal').modal('show');
                })

            </script>
        </div>
        <!-- 合同 -->
        <div class="tab-pane fade back_box" id="tab11">
            <h4 class="page-header clearfix">
                <span>{:L('THE_RELEVANT_CONTRACT')}</span>
                <if condition="$customer['is_deleted'] == 0">
                    <div class="pull-right">
                        <a class="btn btn-primary btn-sm" href="{:U('contract/add')}">{:L('ADD')}</a>
                    </div>
                <else/>
                    <span class="pull-right">{:L('HAS BEEN REMOVED')}</span>
                </if>
            </h4>
            <table class="table table-hover">
                <if condition="$customer['contract'] eq null">
                    <tr>
                        <td <if condition="C('ismobile') neq 1">colspan="6"<else />colspan="4"</if>>{:L('THERE_IS_NO_DATA')}</td>
                    </tr>
                <else /> 
                    <tr>
                        <td>&nbsp;</td>
                        <td>{:L('Contract_no')}</td>
                        <td>{:L('SIGNING_TIME')}</td>
                        <td>{:L('OFFER')}</td>
                        <if condition="C('ismobile') neq 1"><td>{:L('PRINCIPAL')}</td>
                        <td>{:L('CREATION_TIME')}</td></if>
                    </tr>
                    <volist name="customer.contract" id="vo">
                        <tr>
                            <td class="tdleft"><if condition="$customer['is_deleted'] == 0"><a  href="{:U('contract/view','id='.$vo['contract_id'])}">{:L('CHECK')}</a> &nbsp; <a  href="{:U('contract/edit','id='.$vo['contract_id'])}">{:L('COMPILE')}</a></if></td>
                            <td>
                                <a  href="{:U('contract/view','id='.$vo['contract_id'])}">{$vo.number}</a>
                            </td>                                   
                            <td><notempty name="vo.due_time">{$vo.due_time|date="Y-m-d",###}</notempty></td>
                            <td>
                                {$vo.price}
                            </td>
                            <if condition="C('ismobile') neq 1">
                            <td>
                                <notempty name="vo.owner.user_name"><a class="role_info" rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a></notempty>
                            </td>
                            <td><notempty name="vo.create_time">{$vo.create_time|date="Y-m-d  H:i:s",###}</notempty></td>
                            </if>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 应付款名 -->
        <div class="tab-pane fade back_box" id="tab9">
            <div class="header1">
                <div class="pull-left two-title" >{:L('THE_ACCOUNTS_PAYABLE')}</div>
                <div class="pull-right">
                    <if condition="$customer['is_deleted'] == 0"><a class="btn btn-primary" href="{:U('finance/add','t=payables')}" >{:L('ADD')}</a></if>
                </div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$customer.payables eq null">
                    <tr>
                        <td <if condition="C('ismobile') neq 1">colspan="6"<else/>colspan="4"</if>>{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                <thead>
                    <tr>
                        <td width="15%">&nbsp;</td>
                        <td>{:L('THE_ACCOUNTS_PAYABLE_NAME')}</td>
                        <td>{:L('CONTRACT')}</td>
                        <td>{:L('STATE')}</td>
                        <if condition="C('ismobile') neq 1">
                        <td>{:L('MONEY')}</td>
                        <td>{:L('PRINCIPAL')}</td>
                        </if>
                    </tr>
                </thead>
                <tbody>
                    <volist name="customer.payables" id="vo">
                        <tr>
                            <td class="tdleft"><a href="{:U('finance/view', 't=payables&id='.$vo['payables_id'])}" >{:L('CHECK')}</a></td>
                            <td>
                                <a href="{:U('finance/view', 't=payables&id='.$vo['payables_id'])}" >{$vo.name}</a>
                            </td>
                            <td>
                                <a href="{:U('contract/view', 'id='.$vo['contract_id'])}" >{$vo.contract_name}</a>
                            </td>
                            <td>
                                <if condition="$vo['status'] eq 2">{:L('Payment_has_been')}<elseif condition="$vo['status'] eq 1" />{:L('PART_OF_THE_RECEIVED')}<else />{:L('DID_NOT_RECEIVE_PAYMENT')}</if>
                            </td>
                            <if condition="C('ismobile') neq 1">
                            <td>
                                <if condition="$vo['price'] gt 0">{$vo.price}</if>
                            </td>
                            <td>
                                <notempty name="vo.owner.user_name">
                                <a class="role_info" rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a>
                                </notempty>
                            </td>
                            </if>
                        </tr>
                    </volist>
                </tbody>
                </if>
            </table>
        </div>
        <!-- 任务 -->
        <div class="tab-pane fade back_box" id="tab5">
            <div class="header1">
                <div class="pull-left two-title" >{:L('Related_tasks')}</div>
                <div class="pull-right">
                    <if condition="$customer['is_deleted'] == 0"><a href="javascript:void(0);" class="add_task btn btn-primary">{:L('ADD')}</a></if>
                </div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$customer.task eq null">
                    <tr>
                        <td <if condition="C('ismobile') neq 1">colspan="6"<else />colspan="4"</if>>{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                    <tr>
                        <td width="15%">&nbsp;</td>
                        <td>{:L('THEME')}</td>
                        <td>{:L('STATE')}</td>
                        <td>负责人</td>
                        <td>任务相关人</td>
                        <if condition="C('ismobile') neq 1"><td>{:L('MODIFICATION_TIME')}</td>
                        <td>{:L('DUE_DATE')}</td></if>
                    </tr>
                    <volist name="customer.task" id="vo">
                        <tr>
                            <td class="tdleft">
                                <if condition="$customer['is_deleted'] == 0"><a href="{:U('task/view','id='.$vo['task_id'])}" >{:L('CHECK')}</a>&nbsp; <a href="{:U('task/delete','id='.$vo['task_id'])}" class="del_confirm">{:L('DELETE')}</a>&nbsp; 
                                </if>
                                <if condition="$vo.isclose eq 1"><a href="{:U('task/open','id='.$vo['task_id'])}">{:L('OPEN')}</a><else /><a href="{:U('task/close','id='.$vo['task_id'])}">{:L('CLOSE')}</a></if>
                            </td>
                            <td>
                                <a href="{:U('task/view','id='.$vo['task_id'])}">{$vo.subject}</a>
                            </td>
                            <td>
                                {$vo.status}
                            </td>
                            <td>
                                <notempty name="vo.owner"><volist name="vo.owner" id="v"><a class="role_info" rel="{$v.role_id}" href="javascript:void(0)">{$v.user_name}</a>,</volist></notempty>
                            </td>
                            <td>
                                <notempty name="vo.about_roles"><volist name="vo.about_roles" id="v"><a class="role_info" rel="{$v.role_id}" href="javascript:void(0)">{$v.user_name}</a>,</volist></notempty>
                            </td>
                            <if condition="C('ismobile') neq 1">
                            <td>
                                <notempty name="vo.update_date">{$vo.update_date|date="Y-m-d H:i:s",###}</notempty>
                            </td>
                            <td>
                                <notempty name="vo.due_date">{$vo.due_date|date="Y-m-d H:i:s",###}</notempty>
                            </td>
                            </if>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 日程 -->
        <div class="tab-pane fade back_box" id="tab6">
            <div class="header1">
                <div class="pull-left two-title" >{:L('RELATED_SCHEDULE')}</div>
                <div class="pull-right">
                     <if condition="$customer['is_deleted'] == 0"><a class="btn btn-primary add_event" href="javascript:void(0);" >{:L('ADD')}</a></if>
                </div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$customer.event eq null">
                    <tr>
                        <td <if condition="C('ismobile') neq 1">colspan="6"<else />colspan="4"</if>>{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else /> 
                    <tr>
                        <td width="15%">&nbsp;</td>
                        <td>{:L('THEME')}</td>
                        <td>{:L('SITE')}</td>
                        <td>{:L('PRINCIPAL')}</td>
                        <if condition="C('ismobile') neq 1"><td>{:L('The_start_time')}</td>
                        <td>{:L('THE_END_TIME')}</td></if>
                    </tr>
                    <volist name="customer.event" id="vo">
                        <tr>
                            <td class="tdleft">
                                <if condition="$customer['is_deleted'] == 0"><a href="{:U('event/view','id='.$vo['event_id'])}">{:L('CHECK')}</a>&nbsp; <a href="{:U('event/delete','id='.$vo['event_id'])}" class="del_confirm">{:L('DELETE')}</a>&nbsp;
                                <if condition="$vo.isclose eq 0"><a href="{:U('event/close','id='.$vo['event_id'])}">{:L('CLOSE')}</a><elseif condition="$vo.isclose eq 1" /><a href="{:U('event/open','id='.$vo['event_id'])}">{:L('OPEN')}</a></if></if>
                            </td>
                            <td>
                                {$vo.subject}
                            </td>
                            <td>
                                {$vo.venue}
                            </td>
                            <td>
                                <notempty name="vo.owner.user_name"><a class="role_info" rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a></notempty>
                            </td>
                            <if condition="C('ismobile') neq 1">
                            <td>
                                <notempty name="vo.start_date">{$vo.start_date|date="Y-m-d H:i:s",###}</notempty>
                            </td>
                            <td>
                                <notempty name="vo.end_date">{$vo.end_date|date="Y-m-d H:i:s",###}</notempty>
                            </td>
                            </if>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 文件 -->
        <div class="tab-pane fade back_box" id="tab4">
            <div class="header1">
                <div class="pull-left two-title" >{:L('The_relevant_documents')}</div>
                <div class="pull-right">
                    <if condition="$customer['is_deleted'] == 0"><a class=" add_file btn btn-primary" href="javascript:void(0);" >{:L('ADD')}</a></if>
                </div>
                <div style="clear:both;"></div>
            </div>

            <table class="table table-hover"> 
            <if condition="$customer.file eq null">
                <tr>
                    <td <if condition="C('ismobile') neq 1">colspan="5"<else />colspan="3"</if>>{:L('THERE_IS_NO_DATA')} </td>
                </tr>
            <else /> 
                <tr>
                    <td width="15%">&nbsp;</td>
                    <td>缩略图</td>
                    <td>{:L('FILENAME')}</td>
                    <td>{:L('SIZE')}</td>
                    <if condition="C('ismobile') neq 1"><td>{:L('ADDER')}</td>
                    <td>{:L('ADDTIME')}</td></if>
                </tr>
                <volist name="customer.file" id="vo">
                    <tr>
                        <td class="tdleft">
                            <if condition="$customer['is_deleted'] == 0">
                                <a href="{:U('file/delete', 'id='.$vo['file_id'].'&r=RCustomerFile')}" class="del_confirm">{:L('DELETE')}</a>
                            </if>
                            &nbsp;&nbsp;<a href="javascript:;" class="opener" data="{$vo.name}" data-id="{$vo.file_id}">{:L('EDIT')}</a>
                        </td>
                        <td>
                            <a href="{$vo.file_path}" target="_blank">
                                <div class="screenshot" style="background:url({$vo.file_path}); background-size:cover;"></div>
                            </a>
                        </td>
                        <td>
                            <a target="_blank" href="{$vo.file_path}">{$vo.name}</a>
                        </td>
                        <td>
                            {$vo.size}{:L('BYTE')}
                        </td>
                        <if condition="C('ismobile') neq 1">
                        <td>
                            <notempty name="vo.owner.user_name"><a class="role_info" rel="{$vo.owner.role_id}" href="javascript:void(0)">{$vo.owner.user_name}</a></notempty>
                        </td>
                        <td>
                            <if condition="$vo.create_date neq 0">{$vo.create_date|date="Y-m-d H:i:s",###}</if>
                        </td>
                        </if>
                    </tr>
                </volist>
            </if>
                <tr>
                    <td <if condition="C('ismobile') neq 1">colspan="5"<else />colspan="3"</if>>
                        
                    </td>
                </tr>
            </table>
            <div id="dialog" title="合同名修改">
                <form method="post" action="{:U('editFileName')}">
                    <input type="hidden" name="file_id" id="file_id" value=""/>
                    文件名：<input name="name" id="file_name" value=""/>
                    <input type="submit" value="确定"/>
                </form>
            </div>
        </div>
        <div class="tab-pane fade back_box" id="tab13">
            <div class="header1">
                <div class="pull-left two-title" >相关销售</div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$customer.sales_order eq null">
                    <tr>
                        <td colspan="7">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else/> 
                    <tr>
                        <td>{:L('ORDER_SN')}</td>
                        <td>{:L('THEME')}</td>
                        <td>{:L('TYPE')}</td>
                        <td>{:L('STATE')}</td>
                        <td>{:L('QUANTITY')}</td>
                        <td>{:L('MONEY')}</td>
                        <td>{:L('CREATION_TIME')}</td>
                    </tr>
                    <volist name="customer.sales_order" id="vo">
                        <tr>
                            <td>
                               <a href="{:U('sales/edit', 'id='.$vo['sales_id'])}" >{$vo.sn_code}</a>
                            </td>
                            <td>
                                <a href="{:U('sales/edit', 'id='.$vo['sales_id'])}">{$vo.subject}</a>
                            </td>
                            <td>
                                <if condition="$vo['type'] eq '0'">{:L('SALES')}<else />{:L('SALES_RETURN')}</if>
                            </td>
                            <td>
                                <if condition="$vo['status'] eq '97'">
                                    {:L('NOT_OUTBOUND')}
                                <elseif condition="$vo['status'] eq '98'"/>
                                    {:L('HAVE_BEEN_OUTBOUNDED')}
                                <elseif condition="$vo['status'] eq '99'"/>
                                    {:L('NOT_ENTER')}
                                <elseif condition="$vo['status'] eq '100'"/>
                                    {:L('HAVE_BEEN_ENTERED')}
                                </if>
                            </td>
                            <td>{$vo.total_amount}</td>
                            <td>{$vo.sales_price}</td>
                            <td>{$vo.create_time|date='Y-m-d',###}</td>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 远程服务记录 -->
        <div class="tab-pane fade back_box" id="tab14">
            <div class="header1">
                <div class="pull-left two-title" >远程服务记录</div>
                <div class="pull-right two-title" ><a class="btn btn-primary" href="{:U('service/addRemoteService','customer_id='.$customer['customer_id'])}"><i class="icon-plus"></i>&nbsp; 添加远程记录</a></div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$service_res eq null">
                    <tr>
                        <td colspan="7">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else/> 
                    <tr>
                        <td>操作</td>
                        <td>远程时间</td>
                        <if condition="$remote_type neq ''">
                        <th>远程类型</th>
                        </if>
                        <td>销售人员</td>
                        <td>提交人</td>
                        <td>远程人员</td>
                        <td>审核人</td>
                        <td>审核结果</td>
                    </tr>
                    <volist name="service_res" id="vo">
                    <tr>
                        <td><a href="{:U('service/remoteServiceView','service_id='.$vo['service_id'])}">查看</a></td>
                        <td>{$vo.remote_time}</td>
                        <if condition="$remote_type neq ''">
                        <td>
                            {$vo[$remote_type]}
                        </td>
                        </if>
                        <td>{$vo.sale_people_name}</td>
                        <td>{$vo.fault_subpeople_name}</td>
                        <td>{$vo.service_personal_name}</td>
                        <td>
                            <if condition="$vo.visit_user_name neq ''">
                                {$vo.visit_user_name}
                                <else/>
                                暂无
                            </if>
                        </td>
                        <td>
                            <switch name="vo.return_result">
                                <case value="2">客怨</case>
                                <case value="3">一般</case>
                                <case value="4">满意</case>
                                <case value="5">非常满意</case>
                                <default />暂无
                            </switch>
                        </td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                        <td colspan="7">
                            解决说明：{$vo.desc}
                        </td>
                    <tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 上门服务记录 -->
        <div class="tab-pane fade back_box" id="tab15">
            <div class="header1">
                <div class="pull-left two-title" >上门服务记录</div>
                <div class="pull-right two-title" ><a class="btn btn-primary" href="{:U('doorservice/addHomeDemand','customer_id='.$customer['customer_id'].'&customer_name='.$customer['name'])}"><i class="icon-plus"></i>&nbsp; 添加记录</a></div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$OnSiteService_res eq null">
                    <tr>
                        <td colspan="10">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else/> 
                    <tr>
                        <td>操作</td>
                        <td>上门时间</td>
                        <th>上门类型</th>
                        <td>销售人员</td>
                        <!--<td>提交人</td>-->
                        <td>上门老师</td>
                        <td>回访人</td>
                        <td>审核人</td>
                        <td>回访结果</td>
                        <td>可发提成</td>
                        <td>发放状态</td>
                        <td>提交人</td>
                    </tr>
                    <volist name="OnSiteService_res" id="vo">
                    <tr>
                        <td>
                            <a href="{:U('doorservice/remoteServiceView','id='.$vo['id'])}">查看</a>|
                            <a href="{:U('doorservice/schedu_update','id='.$vo['id'])}">调度</a>|
                            <a href="{:U('doorservice/delete','id='.$vo['id'])}">删除</a>
                        </td>
                        <td>
                            <notempty name="vo['remote_time']">
                                {$vo.remote_time}
                                <else/>
                                暂无
                            </notempty>
                        </td>
                        <td>
                            <switch name="vo['type']">
                                <case value="1">第一次上门</case>
                                <case value="2">第二次上门</case>
                                <case value="3">第三次上门</case>
                                <case value="4">多次上门</case>
                                <case value="5">更换铂金版</case>
                                <default/>暂无
                            </switch>
                        </td>
                        <td>{$vo.saleman}</td>
                        <td>
                            <if condition="$vo['operator_name'] neq ''">
                                {$vo.operator_name}
                                <else/>
                                暂无
                            </if>
                        </td>
                        <td>
                            <if condition="$vo['return_man'] neq ''">
                                {$vo.return_man}
                                <else/>
                                暂无
                            </if>
                        </td>
                        <td>
                            <if condition="$vo['verifier'] neq ''">
                                {$vo.verifier}
                                <else/>
                                暂无
                            </if>
                        </td>
                        <td>
                            <switch name="vo['manyidu']">
                                <case value="4">客怨</case>
                                <case value="3">一般</case>
                                <case value="2">满意</case>
                                <case value="1">非常满意</case>
                                <default />暂无
                            </switch>
                        </td>
                        <td>
                            <notempty name="vo['send_money']">
                                {$vo.send_money}
                            <else/>
                                暂无
                            </notempty>
                        </td>
                        <td>
                            <switch name="vo['send_status']">
                                <case value="1">已发</case>
                                <case value="2">未发</case>
                                <default/>暂无
                            </switch>
                        </td>
                        <td>{$vo.submitter}</td>
                    </tr>
                    <tr>
                        <td>
                        </td>
                        <td colspan="10">
                            解决说明：{$vo.eva}
                        </td>
                    <tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 网络培训服务记录 -->
        <div class="tab-pane fade back_box" id="tab18">
            <div class="header1">
                <div class="pull-left two-title" >记录</div>
                <div class="pull-right two-title" ><a class="btn btn-primary" href="?m=NetTrainService&a=addHomeDemand&customer_id={$customer['customer_id']}&customer_name={$customer['name']}"><i class="icon-plus"></i>&nbsp; 添加记录</a></div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$netTrainService_res eq null">
                    <tr>
                        <td colspan="10">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                <else/>
                    <tr>
                        <td>操作</td>
                        <td>产品名</td>
                        <td>培训时间</td>
                        <th>上门类型</th>
                        <td>销售人员</td>
                        <td>培训老师</td>
                        <td>回访人</td>
                        <td>审核人</td>
                        <td>回访结果</td>
                        <td>可发提成</td>
                        <td>发放状态</td>
                        <td>提交人</td>
                    </tr>
                    <volist name="netTrainService_res" id="vo">
                        <tr>
                            <td>
                                <a href="?m=NetTrainService&a=remoteServiceView&id={$vo['id']}">查看</a>
                                <!--<a href="{:U('NetTrainService/delete','id='.$vo['id'])}">删除</a>-->
                            </td>
                            <td>{$vo.product_name}</td>
                            <td>
                                <notempty name="vo['remote_time']">
                                    {$vo.remote_time}
                                    <else/>
                                    暂无
                                </notempty>
                            </td>
                            <td>
                                <switch name="vo['type']">
                                    <case value="1">第一次培训</case>
                                    <case value="2">第二次培训</case>
                                    <case value="3">第三次培训</case>
                                    <case value="4">多次培训</case>
                                    <case value="5">更换铂金版</case>
                                    <default/>暂无
                                </switch>
                            </td>
                            <td>{$vo.saleman}</td>
                            <td>
                                <if condition="$vo['operator_name'] neq ''">
                                    {$vo.operator_name}
                                    <else/>
                                    暂无
                                </if>
                            </td>
                            <td>
                                <if condition="$vo['return_man'] neq ''">
                                    {$vo.return_man}
                                    <else/>
                                    暂无
                                </if>
                            </td>
                            <td>
                                <if condition="$vo['verifier'] neq ''">
                                    {$vo.verifier}
                                    <else/>
                                    暂无
                                </if>
                            </td>
                            <td>
                                <switch name="vo['manyidu']">
                                    <case value="4">客怨</case>
                                    <case value="3">一般</case>
                                    <case value="2">满意</case>
                                    <case value="1">非常满意</case>
                                    <default />暂无
                                </switch>
                            </td>
                            <td>
                                <notempty name="vo['send_money']">
                                    {$vo.send_money}
                                    <else/>
                                    暂无
                                </notempty>
                            </td>
                            <td>
                                <switch name="vo['send_status']">
                                    <case value="1">已发</case>
                                    <case value="2">未发</case>
                                    <default/>暂无
                                </switch>
                            </td>
                            <td>{$vo.submitter}</td>
                        </tr>
                    </volist>
                </if>
            </table>
        </div>
        <!-- 应收款 -->
        <div class="tab-pane fade back_box" id="tab8">
            <include file="./pages/receivables" />
        </div>
        <!-- 通话记录 -->
        <div class="tab-pane fade back_box" id="tab17">
            <include file="../../Modules/Calling/views/customer/details/records" />
        </div>
        <!-- 快递模块 -->
        <div class="tab-pane fade back_box" id="tab16">
            <div class="header1">
                <div class="pull-left two-title" >{:L('DELIVERY_MODULE')}</div>
                <div class="pull-right">
                    <!--<if condition="$customer['is_deleted'] == 0"><a href="javascript:void(0);" class="add_task btn btn-primary">{:L('ADD')}</a></if>-->
                </div>
                <div style="clear:both;"></div>
            </div>
            <table class="table table-hover">
                <if condition="$express eq null">
                    <tr>
                        <td colspan="10">{:L('THERE_IS_NO_DATA')} </td>
                    </tr>
                 <else/>
                    <tr>
                        <td>快递公司</td>
                        <th>快递单号</th>
                        <td>产品名</td>
                        <td>发送地址</td>
                        <td>操作</td>
                    </tr>
                    <volist name="express" id="vo">
                        <tr>
                            <td>{$vo.express_company}</td>
                            <td>{$vo.express_number}</td>
                            <td>{$vo.content}</td>
                            <td>{$vo.address}</td>
                            <td>
                                <!--<a class="btn btn-default btn-sm" href="#" role="button">编辑</a>-->
                                <a class="btn btn-danger btn-sm"  href="{:U('customer/delete_express', 'express_id='.$vo['express_id'])}" role="button">删除</a>
                            </td>
                        </tr>
                    </volist>
                </if>
            </table>
            <hr/>

        </div>
    </div>
</div>
</div>

<script src="https://cdn.bootcss.com/vue/2.4.4/vue.js"></script>
<script src="https://cdn.bootcss.com/element-ui/1.4.6/index.js"></script>
<script src="https://cdn.bootcss.com/lodash.js/4.17.4/lodash.min.js"></script>

<script>
    var page = {
        customer_info: {
            id: {$customer["customer_id"]},
            owner_role_id: {$customer["owner_role_id"]}
        },
        staff_list: []
    }
    var http = {
        request: function(settings){
            var def = $.Deferred();
            settings.dataType = "JSON";
             $.ajax(settings).then(function (response){
                if (!response.code){
                    def.resolve(response.data);
                } else {
                    def.reject(response.info);
                }
            })

            return def.fail(function(info){
                app.$message.error(info)
            });
        },
        get : function(url, data){
            var settings = {
                url: url,
                data: data,
                type: 'GET'
            };

            return this.request(settings);
        },
        post: function (url, data){
            var settings = {
                url: url,
                data: data,
                type: 'POST'
            };

            return this.request(settings);
        }
    }

    var receiving = {
        getlist: function (order_id, is_deleted) {
            var params = { customer_id: page.customer_info.id };

            is_deleted && (function(){ params.is_deleted = is_deleted })();
            order_id && (function(){ params.order_id = order_id })();

            return http.get('/api.php/finance/get_receiving_list', params);
        },
        get_recycle_bin_list: function () {
            return this.getlist(null, 1);
        },
        recovery: function (receiving_id) {
            return http.get('/api.php/finance/receiving_record_reduction', { record_id: receiving_id });
        }
    }

    var api = {
        receiving: receiving
    }


    var app = new Vue({
        el: '#receiables',
        data: function(){
            return {
                receiving: {
                    list: [],
                    table_data: [],
                    listing_order_number: '',
                    payment_way_options: [{
                            value: 'POS机刷卡',
                            label: 'POS机刷卡'
                        }, {
                            value: '现金',
                            label: '现金'
                        }, {
                            value: '银行转账',
                            label: '银行转账'
                        }, {
                            value: '钟总微信',
                            label: '钟总微信'
                        }, {
                            value: '钟总支付宝',
                            label: '钟总支付宝'
                        }, {
                            value: '转中行',
                            label: '转中行'
                        }, {
                            value: '转工行',
                            label: '转工行'
                        }, {
                            value: '转建行',
                            label: '转建行'
                        }, {
                            value: '转招行',
                            label: '转招行'
                        }, {
                            value: '转交行',
                            label: '转交行'
                        }, {
                            value: '转农行',
                            label: '转农行'
                        }, {
                            value: '转邮政',
                            label: '转邮政'
                        }, {
                            value: '转中信银行',
                            label: '转中信银行'
                        }, {
                            value: '抵工资',
                            label: '抵工资'
                        }, {
                            value: '信用卡还款',
                            label: '信用卡还款'
                        }, {
                            value: '微领地小蜜',
                            label: '微领地小蜜'
                        }, {
                            value: '转对公账户(利亚方舟中行)',
                            label: '转对公账户(利亚方舟中行)'
                    }],
                    form: {
                        order_id: '',
                        order_number: '',
                        payment_way: '',
                        amount: 0.00,
                        receiving_time: '',
                        description: ''
                    },
                    dialog: {
                        visible: false,
                        owner_selected: [],
                    },
                    recycle_bin: {
                        table_data: [],
                        dialog: {
                            visible: false,
                        },
                    }
                },
                order: {
                    list: [],
                    product_list_clone: [],
                    form: {
                        name: '',
                        total: 0.00,
                        create_time: '',
                        description: '',
                        product_list: []
                    },
                    dialog: {
                        visible: false,
                        product_selected_list: [],
                        owner_selected: [],
                        table_list: []
                    },
                    details_dialog: {
                        visible: false,
                        details: {} 
                    }
                },
                department_list: [],
                product_list: [],
                product_tmp: [],
                date_tmp: new Date(),
                // 多选点击状态
                selectCheckData: [],
                receivingorder_id_str:null,
                takeInMoney: {
                    price: '',
                    received: '',
                    arrearage: ''
                }
            }
        },
        methods: {
            selectCheck: function (selection) {
                var receivingorder_id_arr = []
                this.selectCheckData = selection
                for(var receivingorder_id of this.selectCheckData){
                    receivingorder_id_arr.push(receivingorder_id.receivingorder_id)
                }
                var receivingorder_id_str = receivingorder_id_arr.join(',')
                this.receivingorder_id_str = receivingorder_id_str
            },
            financeLink: function(){
                window.open("/index.php?m=finance&a=orderprint&receivingorder_id="+this.receivingorder_id_str);
            },
            load_staff: function(department_info){
                // department_info = department_info[0];
                var option = _.find(this.department_list, function(item){return item.value.department_id == department_info.department_id});
                if (!option || option.children.length == 0){
                    $.get('/api.php/staff/getlist', {department_id: department_info.department_id}).then(function(response){
                        var staff_list = response.data;
                        if (!staff_list) return;
                        _.forEach(staff_list, function(user_info){
                            option.children.push({
                                value: {
                                    user_id: user_info.user_id,
                                    user_name: user_info.name
                                },
                                label: user_info.name
                            });
                        });
                        page.staff_list = _.concat(page.staff_list, staff_list);
                    }.bind(this));
                }
            },
            load_product: function(category_info){
                category_info = category_info[0];
                var option = _.find(this.product_list, function(item){return item.value.category_id == category_info.category_id});
                if (!option || option.children.length == 0){
                    $.get('/api.php/product/getlist', {category_id: category_info.category_id}).then(function(response){
                        var product_list = response.data.product_list;
                        _.forEach(product_list, function(product_info){
                            option.children.push({
                                value: product_info,
                                label: product_info.name
                            });
                        });
                    }.bind(this));
                }
            },
            // 是否确定收款 选中后的事件
            product_select: function(product_info){
                product_info = product_info[1];
                if (product_info){
                    this.order.dialog.product_selected_list.push(product_info);
                }
                this.product_tmp = []
                this.order.dialog.table_list.push({ name: product_info.name, product_id: product_info.product_id, suggested_price: product_info.suggested_price, showStatus: false });
                this.order.product_list_clone.push({ name: product_info.name, product_id: product_info.product_id, suggested_price: product_info.suggested_price, showStatus: false });
            },
            // 是否确定收款 表格里面的删除事件
            del_prod: function(index, data, price) {
                this.order.dialog.table_list.splice(index, 1)
                this.order.product_list_clone.splice(index, 1)
                this.calculate_sum_of_suggested_price()
                this.order.form.name = this.order.form.name.split(',')
                this.order.form.name.splice(index, 1)
                this.order.form.name = this.order.form.name.join(',')
                this.order.dialog.product_selected_list.splice(index, 1)
                this.$message.success('删除成功')
            },
            // 是否确定收款 表格里面的更改价格确认事件
            true_gai: function(index, data) {
                this.order.product_list_clone[index].suggested_price = data[index].suggested_price
                var reg = /^[0-9]*$/
                if (!reg.test(data[index].suggested_price)) {
                    this.$message.success('请填写正确金额格式')
                    return
                }
                this.$message.success('修改成功')
                this.calculate_sum_of_suggested_price()
                data[index].showStatus = false
            },
            delete_product_selected: function(dist_index){
                this.order.dialog.product_selected_list.splice(dist_index, 1);
            },
            calculate_sum_of_suggested_price: function(){
                var sum_of_suggested_price = 0.00;
                _.forEach(this.order.product_list_clone, function(product){
                    sum_of_suggested_price += parseFloat(product.suggested_price)
                });
                this.order.form.total = sum_of_suggested_price;
            },
            order_create_time_date_picked: function(datestring){
                this.order.form.create_time = datestring;
            },
            receiving_time_date_picked: function(datestring){
                this.receiving.form.receiving_time = datestring;
            },
            get_owner_cascader_value: function(user_id){
                var owner_info = _.find(page.staff_list, function(item){return item.user_id == user_id});
                if (!owner_info) {
                    return null;
                }
                var department_options = _.find(this.department_list, function(item){
                    return item.value.department_id == owner_info.department_id
                });

                var owner_info_options = _.find(department_options.children, function(item){
                    return item.value.user_id == user_id
                });

                return [department_options.value, owner_info_options.value];
            },
            // 收款点击的方法
            open_receving_dialog: function(order_info){

                this.takeInMoney.price = order_info.price;
                this.takeInMoney.received = order_info.received;
                this.takeInMoney.arrearage = order_info.arrearage;
                //点击收款后把price，received，arrearage传给this.takeInMoney

                var owner_role_id = order_info.owner_role_id ;
                if (owner_role_id == -1){
                    owner_role_id = page.customer_info.owner_role_id;
                }
                
                this.receiving.dialog.owner_selected = this.get_owner_cascader_value(owner_role_id);

                this.receiving.form.order_id = order_info.order_id;
                this.receiving.form.order_number = order_info.order_number;
                this.receiving.form.description = order_info.name;
                this.receiving.dialog.visible = true;
                this.date_tmp = new Date();
            },
            // 订单/收款 添加时的事件
            open_create_order_dialog: function(){
                this.order.dialog.table_list = []
                this.order.product_list_clone = []
                this.calculate_sum_of_suggested_price()
                var cascader_value = this.get_owner_cascader_value(page.customer_info.owner_role_id);

                if (cascader_value) this.order.dialog.owner_selected = cascader_value;

                this.order.dialog.visible = true;
                
                this.date_tmp = new Date();
            },
            delete_order: function(row_info, event){
                var row = row_info.row,
                    index = row_info.$index;
                http.get('/api.php/finance/delete_order', { order_id: row.order_id }).then(function(data){
                    this.order.list.splice(index, 1)
                }.bind(this));

                event.stopPropagation();
            },
            delete_receiving: function(index, row_info, completely){
                var receiving_info = row_info[index];
                    var params = null
                    receiving_info.receiving_id ? params = { record_id: receiving_info.receiving_id } : params = { record_id: receiving_info.receivingorder_id }
                completely && (function(){ params.completely_delete = 1 })();

                var do_delete = function(){
                    http.get('/api.php/finance/delete_receiving_record', params).then(function(data){
                        if (completely){
                            this.receiving.recycle_bin.table_data.splice(index, 1)
                        } else {
                            this.receiving.table_data.splice(index, 1)
                            this.receiving.list.splice(index, 1)
                        }
                    }.bind(this));
                }.bind(this)

                if (params.completely_delete) {
                    this.$confirm('此操作将彻底删除该财务数据', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(function(){
                        do_delete();
                    })
                } else {
                    do_delete();
                }
            },
            recovery_receiving: function(row_info){
                api.receiving.recovery(row_info.row.receivingorder_id).then(function(){
                    window.location.reload();
                })
            },
            open_order_details_dialog: function(row){

                http.get('/api.php/finance/get_order_details', {order_id: row.order_id}).then(function(data){
                    this.order.details_dialog.details = data.details;
                    this.order.details_dialog.visible = true;
                }.bind(this));
                
            },
            create_order: function(){
                this.order.form.product_list = []
                this.order.form.customer_id = page.customer_info.id;
                for (var i=0; i<this.order.product_list_clone.length; i++) {
                    this.order.form.product_list.push(this.order.product_list_clone[i].product_id + ':' + this.order.product_list_clone[i].suggested_price)
                }
                this.order.form.product_list = _.join(this.order.form.product_list, ',')
                http.post('/api.php/finance/save_order', this.order.form).then(function(data){
                    data.order_info.owner_name = this.order.dialog.owner_selected[1].user_name;

                    Object.defineProperty(data.order_info, "arrearage", {
                        get: function(){
                            var received = _.sumBy(this.receiving.list, function(receiving){
                                if (receiving.order_id == data.order_info.order_id) {
                                    return parseFloat(receiving.amount);
                                }
                                return 0
                            });

                            return (data.order_info.price - received).toFixed(2);
                        }.bind(this),
                    });
                    data.order_info.price = parseFloat(data.order_info.price).toFixed(2);
                    this.order.list.unshift(data.order_info);

                    this.order.form = { total: 0.00, create_time: '', description: '' }

                    this.order.dialog = { visible: false, product_selected_list: [], owner_selected: [] }

                    this.$message('下单成功');
                }.bind(this));
            },
            // 收款提交ajax请求
            shoukuanMethods: function(){
                http.post('/api.php/finance/receiving_money', this.receiving.form)
                .then(function(data){
                    var receiving_info = data.receiving_info;

                    receiving_info.owner_name = this.receiving.dialog.owner_selected[1].user_name

                    receiving_info.amount = parseFloat(receiving_info.amount).toFixed(2);

                    this.receiving.list.unshift(receiving_info);

                    this.show_receiving_list_by_order_number(receiving_info.order_number);

                    this.receiving.dialog.visible = false;

                    api.receiving.getlist().then(function(response){
                        if (response) {
                            this.receiving.table_data = this.receiving.list = response
                        }
                    });
                    
                    this.$message('收款成功');
                }.bind(this))
            },
            receiving_money: function(){
                // 判断收款金额是否大于欠款金额
                let jine = parseInt(this.takeInMoney.received) + parseInt(this.receiving.form.amount)
                if( jine > this.takeInMoney.price) {
                    // 如果全款+收款>金额，就执行
                    // this.qiankuanjine = true
                    this.$confirm('收款金额大于总金额, 是否继续?', '提示', {
                      confirmButtonText: '确定',
                      cancelButtonText: '取消',
                      type: 'warning'
                    }).then(() => {
                      this.shoukuanMethods() 
                      this.$message({
                        type: 'success',
                        message: '成功!'
                      });
                    }).catch(() => {
                      this.$message({
                        type: 'info',
                        message: '已取消'
                      });          
                    })
                }else{
                    this.shoukuanMethods()
                }
            },
            order_table_row_click: function(row){
                this.receiving.listing_order_number = row.order_number;
            },
            open_order_preview: function(row){
                window.open("/index.php?m=finance&a=orderprint&order_id="+row.order_id);
            },
            show_receiving_list_by_order_number: function(order_number){
                this.receiving.table_data = !order_number ? 
                    this.receiving.list :  this.receiving.list.filter(function(item){return item.order_number == order_number});
            },
            open_receiving_recycle_bin: function(){
                this.receiving.recycle_bin.dialog.visible = true
                api.receiving.get_recycle_bin_list().then(function(response){
                    this.receiving.recycle_bin.table_data = response
                }.bind(this));
            }
        },
        created: function(){
            
            $.get('/api.php/finance/get_order_list', {
                customer_id: page.customer_info.id
            }).then(function(response){
                if (response.data.order_list){
                    _.forEach(response.data.order_list, function(order){
                        // order.arrearage = (parseFloat(order.price) - parseFloat(order.received)).toFixed(2)
                        Object.defineProperty(order, "arrearage", {
                            get: function(){
                                var received = _.sumBy(this.receiving.list, function(receiving){
                                    if (parseInt(receiving.status) === 1 && parseInt(receiving.order_id) == parseInt(order.order_id)) {
                                        return parseFloat(receiving.amount);
                                    }
                                    return 0
                                });

                                return (order.price - received).toFixed(2);
                            }.bind(this),
                        })

                    }.bind(this))
                    this.order.list = response.data.order_list
                }
            }.bind(this));

            api.receiving.getlist().then(function(response){
                if (response) {
                    this.receiving.table_data = this.receiving.list = response
                }
            }.bind(this));

            $.get('/api.php/department/getlist').then(function(response){
                var department_list = response.data;
                _.forEach(department_list, function(department_info){
                    this.department_list.push({
                        value: {
                            department_id: department_info.department_id
                        },
                        label: department_info.name,
                        children: []
                    });
                    this.load_staff(department_info);
                }.bind(this));
            }.bind(this));

            $.get('/api.php/product/getCategories').then(function(response){
                var categories = response.data.categories;
                _.forEach(categories, function(category_info){
                    this.product_list.push({
                        value: {
                            category_id: category_info.category_id
                        },
                        label: category_info.name,
                        children: []
                    });
                }.bind(this));
            }.bind(this));
        },
        watch: {
            'receiving.dialog.owner_selected': function(value){
                if (value.length > 1){
                    this.receiving.form.owner_role_id = value[1].user_id
                }
            },
            'order.dialog.owner_selected': function(value){
                if (value.length > 1){
                    this.order.form.owner_role_id = value[1].user_id
                }
            },
            'order.dialog.product_selected_list': function(){
                // this.order.form.product_list = _.map(this.order.dialog.product_selected_list, 'product_id').join(',');
                this.order.form.name = _.map(this.order.dialog.product_selected_list, 'name').join(',');
                this.calculate_sum_of_suggested_price();
                // _.forEach(this.order.dialog.product_selected_list, function(item){
                //     this.order.form.product_list.push(item.product_id);
                // }.bind(this));
            },
            'receiving.listing_order_number': function(value){
                this.show_receiving_list_by_order_number(value);
            }
        },
        computed: {
            total_consumption: function(){
                return _.sumBy(this.order.list, function(order){return parseFloat(order.price)});
            },
            total_received: function(){
                return _.sumBy(this.order.list, function(order){return parseFloat(order.received)});
            },
            total_arrearage: function(){
                return this.total_consumption - this.total_received;
            }
        }
    });


    window.onhashchange = function(){
        var hash = window.location.hash
        document.cookie = 'tab='+hash ;
        if (!hash){
            hash = $('.list-group .list-group-item').eq(1).attr('href');
        }

        $('.list-group a[href="' + hash + '"]').tab('show');

        $('.list-group-item').removeClass('active');

        $('.list-group-item[href=\''+hash+'\']').addClass('active');

    }


    window.onhashchange();
</script>

<div class="dialog" id="dialog-file" title="{:L('ADD_ATTACHMENT')}">loading...</div>
<div class="dialog" id="dialog-log" title="{:L('Add_the_log')}">loading...</div>
<div class="dialog" id="dialog-log-edit" title="{:L('EDIT_LOG')}">loading...</div>
<div class="hide" id="dialog-task" title="{:L('ADD_TASKS')}">loading...</div>
<div class="hide" id="dialog-role-info" title="{:L('EMPLOYEE_INFORMATION')}">loading...</div>
<div class="hide" id="dialog-event" title="{:L('ADD_THE_SCHEDULE')}">loading...</div>
<div class="hide" id="dialog-fenpei" title="{:L('DISTRIBUTION_OF_CUSTOMERS')}">loading...</div>
<div class="hide" id="dialog-map" title="{:L('MAP')}">loading...</div>
<div class="hide" id="dialog-share" title="客户共享">loading...</div>

<div id="modal-receiving" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">收款</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <form class="form form-horizontal" action="">
                        <div class="form-group">
                            <label class="control-label col-md-3">负责人: </label>
                            <div class="col-md-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3">收款金额: </label>
                            <div class="col-md-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3">收款时间: </label>
                            <div class="col-md-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3">状态: </label>
                            <div class="col-md-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3">描述: </label>
                            <div class="col-md-9">
                                <input type="text" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/jqueryui/1.12.1/jquery-ui.min.js"></script>
<!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Z0Fo0ib1GUgWlylCWeLvQh2U"></script> -->
<script>
    (function($){
        var store = {};
        $('#btn-receive-money').on('click', function(){
            $('#modal-receiving').modal();
        });
        $(".dialog").dialog({
            autoOpen: false,
            modal: true,
            width: 800,
            maxHeight: 400,
            position: { my: "bottom", at: "center", of: window }
        });
        $(".add_file").click(function(){
            $('#dialog-file').dialog('open');
            $('#dialog-file').load('/index.php?m=file&a=add&r=RCustomerFile&module=customer&id='+page.customer_info.id);
        });

        $(".add_log").click(function(){
            $('#dialog-log').dialog('open');
            $('#dialog-log').load('/index.php?m=log&a=add&r=RCustomerLog&module=customer&id='+page.customer_info.id);
        });
        $(".edit_log").click(function(){
            $log_id = $(this).attr('rel');
            $('#dialog-log-edit').dialog('open');
            $('#dialog-log-edit').load('/index.php?m=log&a=edit&id='+$log_id);
	    });
        $( "#dialog" ).dialog({
            autoOpen: false,
            show: {
                effect: "blind",
                duration: 1000
            },
            hide: {
                effect: "explode",
                duration: 1000
            }
        });

        $( ".opener" ).click(function() {
            $("#dialog").dialog( "open" );
            $('#file_name').val($(this).attr('data'));
            $('#file_id').val($(this).attr('data-id'));
        });
    })(jQuery);
</script>

<include file="Public:footer" />