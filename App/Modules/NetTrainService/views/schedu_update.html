<include file="Public:header" />
<script src="__PUBLIC__/js/PCASClass.js" type="text/javascript"></script>
<script type="text/javascript" src="__PUBLIC__/js/formValidator-4.0.1.min.js" charset="UTF-8"></script>
<script type="text/javascript" src="__PUBLIC__/js/formValidatorRegex.js" charset="UTF-8"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.combo.select.js" charset="UTF-8"></script>
<link type="text/css" href="__PUBLIC__/css/combo.select.css" rel="stylesheet">

<style>
    .screenshot{
        width:210px;
        height:210px;
        background-color:red;
        float:left;
        border:1px solid #ccc;
        border-radius:5px;
        margin:10px 10px;
    }
    
    .notFloat{
        text-align:center;
        clear:both;
    }
    
    .onTheLeft{
        float:left;
    }
</style>

<div class="container">
	<div class="page-header">
        <h4>{:L('Add_the_door_needs')}</h4>
	</div>
	<div class="row">
		<div class="span12">
			<include file="Public:alert" />
            <form id="form1" action="{:U('schedu_edit')}" method="post">
			     <!--<input type="hidden" name="refer_url" value="{$refer_url}">-->
                <input type="hidden" name="id" value="{$vo.id}">
                <table class="table" width="95%" border="0" cellspacing="1" cellpadding="0">
					<tbody>
						<tr><th colspan="4">{:L('client_information')}</th></tr>
                        <tr>
                            <td class="tdleft" >{:L('The_name_of_the_studio')}:</td>
                            <td>
                                <input type="text" name="customer_name" id="customer_name" value="{$vo.customer_name}" readonly>
                            </td>
                            <td class="tdleft" >{:L('First_name')}:</td>
                            <td>
                                <input type="hidden" name="contacts_id" id="contacts_id">
                                <input type="text" name="contacts_name" id="contacts_name" value="{$vo.contacts_name}" readonly>
                            </td>
						</tr>
                        <tr>
                            <td class="tdleft" >{:L('First_number')}:</td>
                            <td>
                                <input type="text" name="contacts_telephone" id="contacts_telephone" value="{$vo.contacts_telephone}" readonly>
                            </td>
                            <td class="tdleft" >{:L('Customer_need')}:</td>
                            <td>
                                <input type="text" name="client_need" id="client_need" value="{$vo.client_need}" readonly>
                            </td>
                        </tr>
                        <tr>
                            <td class="tdleft" width="15%">{:L('Studio_contact_address')}:</td>
                            <td colspan="3">
                                <input type="text" style="width: 791px" name="address" id="address" value="{$vo.address}" readonly>
                            </td>
                        </tr>
                        <tr>
                            <td class="tdleft" width="15%">{:L('The_door_type')}:</td>
                            <td >
                                <select name='type' disabled>
                                    <option value="1" <if condition="$vo['type'] eq 1">selected</if>>{:L('first_the_door')}</option>
                                    <option value="2" <if condition="$vo['type'] eq 2">selected</if>>{:L('second_the_door')}</option>
                                    <option value="3" <if condition="$vo['type'] eq 3">selected</if>>{:L('third_the_door')}</option>
                                    <option value="4" <if condition="$vo['type'] eq 4">selected</if>>{:L('more_the_door')}</option>
                                </select>
                            </td>
                            <td class="tdleft" >{:L('SALESMAN')}:</td>
                            <td>
                                <input type="hidden" name="sid" value="{$vo.sid}">
                                <input type="text" name="saleman" value="{$vo.saleman}" disabled>
                            </td>
                        </tr>
                        <tr>
                            <!--提交人-->
                            <td class="tdleft" >{:L('Saleman')}:</td>
                            <td>
                                <input type="hidden" name="submitter_id" id="submitter_id" value="{$vo.submitter_id}" />
                                <input type="text" id="submitter" name="submitter" value="{$vo.submitter}"  readonly>
                            </td>
                            <if condition="$vo['type'] neq 1">
                                <td class="tdleft" >{:L('LAST_TIME_MAN')}:</td>
                                <td>
                                    <input type="hidden" name="last_id" id="last_id" value="{$vo.last_id}" />
                                    <input type="text" name="last_man" id="last_man" value="{$vo.last_man}" readonly>
                                </td>
                            </if>
                        </tr>
                        <tr>
                            <th colspan="4">{:L('Scheduling')}</th>
                        </tr>
                        <tr>
                            <td class="tdleft" >{:L('training_teacher')}:</td>
                            <td>
                                <input type="hidden" name="tid" id="tid" value="{$vo.tid}">
                                <input class="user_input" type="text" value="{$vo.operator_name}" id="operator_name" name="operator_name">
                            </td>
                            <td class="tdleft" >{:L('Training_status')}:</td>
                            <td>
                                <select name='status'>
                                    <!-- <option value="1" <if condition="$vo['status'] eq 1">selected</if>>{:L('I_arrangements')}</option> -->
                                    <!-- <option value="2" <if condition="$vo['status'] eq 2">selected</if>>{:L('teacher_has_contact')}</option> -->
                                    <option value="3" <if condition="$vo['status'] eq 3">selected</if>>{:L('in_training')}</option>
                                    <!-- <option value="4" <if condition="$vo['status'] eq 4">selected</if>>{:L('training_over')}</option> -->
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="tdleft" >{:L('Dispatch_note')}:</td>
                            <td colspan="3">
                                <textarea class="span8" rows="3"  name="desc" id="desc">{$vo.desc}</textarea>
                            </td>
                        </tr>
					</tbody>
					<tfoot>
						<tr>
							<td style="text-align:center;" colspan="4">
                                <input class="btn btn-primary" id="check" type="submit" value="{:L('Save')}"/>
                                <input class="btn btn-primary check"  type="button" id="save_and_next" value="{:L('SAVE_AND_NEXT')}"/>
                                <input class="btn" type="reset" onclick="javascript:history.go(-1)" value="{:L('RETURN')}"/>
							</td>
						</tr>
					</tfoot>
                </table>
                <if condition="$leads['leads_id']"><input type="hidden" name="leads_id" value="{$leads['leads_id']}"/></if>
		    </form>	
		</div>
	</div>
</div>
<!-- 地图 -->
<!-- 地图隐藏 
<div id="mapContainer" style="width:1200px; height:400px;margin: 0 auto;"></div>
<div class="button-group" id='button_group' style='top:15px;bottom:inherit'></div>
-->
<!-- 地图结束 -->

<div class="hide" id="dialog-message" title="影楼名称">loading...</div>
<div class="hide" id="dialog-role-list" title="人员选择">loading...</div>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=xrICWNuDGQwoI32qEGHuILYMcw0zsTW2"></script>

<script type="text/javascript">
    var identification
    
    $(function() {
        $('#remote_type').comboSelect();
    });
    $('#save_and_next').click(function () {
        $('#form1').attr('action', "{:U('schedu_edit','is_next=1')}");
        $("#form1").submit();
    });
    //影楼选择
    $('#customer_name').click(function () {
		$('#dialog-message').dialog('open');
		$('#dialog-message').load("/index.php?m=customer&a=listDialog");
	});
    $('#dialog-message').dialog({
        autoOpen: false,
        modal: true,
        width: 800,
        maxHeight: 400,
        buttons: {
            "确定": function () {
                item = $('input:radio[name="customer"]:checked').val();
                name = $('input:radio[name="customer"]:checked').parent().next().html();
                contacts_id = $('input:radio[name="customer"]:checked').attr('rel');
                contacts_name = $('input:radio[name="customer"]:checked').next().attr('value');
                contacts_telephone = $('input:radio[name="customer"]:checked').next().next().attr('value');
                address = $('input:radio[name="customer"]:checked').next().next().next().attr('value');
                create_name = $('input:radio[name="customer"]:checked').next().next().next().next().attr('value');
                create_user_id = $('input:radio[name="customer"]:checked').next().next().next().next().attr('rel');
                owner_name = $('input:radio[name="customer"]:checked').next().next().next().next().next().attr('value');
                owner_user_id = $('input:radio[name="customer"]:checked').next().next().next().next().next().attr('rel');

                $('#customer_name').val(name);
                $('#customer_id').val(item);
                $('#contacts_id').val(contacts_id);
                $('#contacts_name').val(contacts_name);
                $('#contacts_telephone').val(contacts_telephone);
                $('#address').val(address);
                $('#create_name').val(create_name);
                $('#create_id').val(create_user_id);

                $('[mark=teacher]').val(owner_name);
                $('#teacher_id').val(owner_user_id);
                
                $(this).dialog("close");
            },
            "关闭": function () {
                $(this).dialog("close");
            }
        },
        position:["center",100]
    });
    
    //上门人选择
	$('#operator_name').click(function(){
        identification = $(this).attr('identification');
        $('#dialog-role-list').dialog('open');
        $('#dialog-role-list').load("{:U('user/listDialog')}");
    });
    $("#dialog-role-list").dialog({
        autoOpen: false,
        modal: true,
        width: 800,
        maxHeight: 400,
        buttons: { 
            "确定": function () {
                var item = $('input:radio[name="owner"]:checked').val();
                var name = $('input:radio[name="owner"]:checked').parent().next().html();
                if(item){
                    $('[identification='+identification+']').val(name);
                    $('[identification_id='+identification+']').val(item);
                }
                $('#operator_name').val(name) ;
                $('#tid').val(item) ;
                $(this).dialog("close"); 
            },
            "关闭": function () {
                $(this).dialog("close");
            }
        },
        position: ["center", 100]
    });
</script>
<!--地图人员显示-->
<script>
// 初始化地图
var map = new BMap.Map("mapContainer");          // 创建地图实例
var point = new BMap.Point(105,32);  // 创建点坐标
var arr = [];
var data = []
var trList = []
var unameList = []
var image = ''
var address = $('#address').val();
var customer_name = $('#customer_name').val();
map.centerAndZoom(point,5);
map.enableScrollWheelZoom(true);
var myGeo = new BMap.Geocoder();
loadmap() ;

function staff_init(arr) {
    for (let i = 0; i < arr.length; i++) {
//            var myIcon = new BMap.Icon("http://lbsyun.baidu.com/jsdemo/img/fox.gif", new BMap.Size(200,103));
        let myIcon = new BMap.Icon(arr[i].img, new BMap.Size(30,30));
        let point = new BMap.Point(parseFloat(arr[i].y),parseFloat(arr[i].x));
        let marker = new BMap.Marker(point,{
            icon: new BMap.Symbol(BMap_Symbol_SHAPE_POINT, {
                scale: 1.5,//图标缩放大小
                fillColor: "orange",//填充颜色
                fillOpacity: 0.8//填充透明度
            })
        });  // 创建标注
        map.addOverlay(marker);
        marker.setLabel(new BMap.Label(arr[i].label,{offset:new BMap.Size(-13,-15)}));
        myGeo.getLocation(new BMap.Point(point), function(rs){
            if (rs){
                var marker2 = new BMap.Marker(point,{icon:myIcon});  // 创建标注
                map.addOverlay(marker2);              // 将标注添加到地图中
            }
        });
    }
}
function loadmap(){
    trList.splice(0,trList.length);
    unameList.splice(0,unameList.length);
    arr.splice(0, arr.length);
    address_name = []
    $(".address_name").each(function(){
        trList.push($(this).attr('address').replace(/\s/g,''))
    });
    var uname = document.getElementsByClassName('uname');
    // 1 查询是否有人打卡
    $.ajax({
        type:"POST",
        url:"{:U('getSign')}",
        dataType:"json",
        success:function(signData){
            console.log(signData);
            if(signData.errcode == 0){
                for (let item of signData.data) {
                    data = {
                        x:item.latitude,
                        y:item.longitude,
                        img:item.avatar,
                        label:item.name ,
                    }
                    arr.push(data);
                }
            }else{
                console.log('没人打卡');
            }
            staff_init(arr);
        }
    });

    // 2 地图店家位置
    // 创建地址解析器实例
    var myGeo = new BMap.Geocoder();
    // 将地址解析结果显示在地图上,并调整地图视野
    myGeo.getPoint(address, function(point){
        if (point) {
            let marker = new BMap.Marker(point,{
                icon: new BMap.Symbol(BMap_Symbol_SHAPE_POINT, {
                    scale: 1.4,//图标缩放大小
                    fillColor: "red",//填充颜色
                    fillOpacity: 0.8//填充透明度
                })
            });
            map.centerAndZoom(point,8);
            // 创建标注
            map.addOverlay(marker);              // 将标注添加到地图中
            marker.addEventListener("mousedown",function(){
                var opts={width:300,height:30,title:"客户信息"};
                var infoWindow = new BMap.InfoWindow('影楼名称：'+customer_name+'<br/>影楼地址：'+address,opts);
                map.openInfoWindow(infoWindow,point);
            });
            marker.addEventListener("mouseup",function(){
                map.closeInfoWindow();
            });
            var circle = new BMap.Circle(point,100000,{fillColor:"blue", strokeWeight: 1 ,fillOpacity: 0.3, strokeOpacity: 0.3});
            map.addOverlay(circle);
//            var local =  new BMap.LocalSearch(map, {renderOptions: {map: map, autoViewport: false}});
//            local.searchNearby('餐馆',point,1000000);
        }else{
            console.log("您选择地址没有解析到结果!");
        }
    });
}

</script>
<include file="Public:footer" />